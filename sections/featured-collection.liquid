{% stylesheet %}
  .product-card {
    flex: 0 0 calc(
      (100% - (var(--slides-per-view) - 1) * 20px)
      / var(--slides-per-view)
    );
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    overflow: hidden;
    box-sizing: border-box;
  }

{% endstylesheet %}

<div class="featured-collection" style="--slides-per-view: {{ section.settings.slides_per_view }}">
  <div class="featured-collection__header">
    <h2 class="featured-collection__title">{{ section.settings.title }}</h2>
    {% if section.settings.description %}
      <p>{{ section.settings.description }}</p>
    {% endif %}
  </div>

  {% if section.settings.collection %}
    <div class="slider-container">
      <div class="featured-collection__products" data-slider>
        {% for product in section.settings.collection.products limit: section.settings.products_limit %}
          <div class="product-card">
            {% render 'product-card', product: product %}
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="slider-controls">
      <button class="slider-btn" data-prev>❮</button>
      <button class="slider-btn" data-next>❯</button>
    </div>
    {% if section.settings.dot_enable %}
    <div class="slider-dots" data-dots></div>
    {% endif %}
    {% if section.settings.view_all_enable %}
    <div class="view_all_btn">
      <a href="{{ section.settings.collection.url }}" class="view-all-btn">
      View All Products
      </a>
    </div>
    {% endif %}
  {% endif %}
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const slider = document.querySelector('[data-slider]');
  if (!slider) return;

  const prevBtn = document.querySelector('[data-prev]');
  const nextBtn = document.querySelector('[data-next]');
  const dotsContainer = document.querySelector('[data-dots]');

  const config = {
    slidesPerView: {{ section.settings.slides_per_view }},
    autoplay: {{ section.settings.autoplay | json }},
    autoplaySpeed: {{ section.settings.autoplay_speed }} * 1000,
    pauseOnHover: {{ section.settings.pause_on_hover | json }}
  };

  let currentIndex = 0;
  let autoplayInterval = null;

  const slides = slider.querySelectorAll('.product-card');
  const totalSlides = slides.length;
  const maxIndex = Math.max(0, totalSlides - config.slidesPerView);

  if (dotsContainer) {
    for (let i = 0; i <= maxIndex; i++) {
      const dot = document.createElement('div');
      dot.className = 'dot';
      if (i === 0) dot.classList.add('active');
      dot.addEventListener('click', () => goToSlide(i));
      dotsContainer.appendChild(dot);
    }
  }

  function updateSlider() {
    const slide = slides[0];
    if (!slide) return;

    const slideWidth = slide.offsetWidth;

    const gap = parseInt(
      window.getComputedStyle(slider).columnGap ||
      window.getComputedStyle(slider).gap ||
      0
    );

    const offset = -((slideWidth + gap) * currentIndex);
    slider.style.transform = `translateX(${offset}px)`;

    updateDots();
  }

  function updateDots() {
    if (!dotsContainer) return;

    dotsContainer.querySelectorAll('.dot').forEach((dot, i) => {
      dot.classList.toggle('active', i === currentIndex);
    });
  }

  function goToSlide(index) {
    currentIndex = Math.max(0, Math.min(index, maxIndex));
    updateSlider();
    resetAutoplay();
  }

  function nextSlide() {
    goToSlide(currentIndex + 1);
  }

  function prevSlide() {
    goToSlide(currentIndex - 1);
  }

  function startAutoplay() {
    if (!config.autoplay) return;
    autoplayInterval = setInterval(nextSlide, config.autoplaySpeed);
  }

  function stopAutoplay() {
    clearInterval(autoplayInterval);
  }

  function resetAutoplay() {
    stopAutoplay();
    startAutoplay();
  }

  prevBtn?.addEventListener('click', prevSlide);
  nextBtn?.addEventListener('click', nextSlide);

  if (config.pauseOnHover) {
    slider.parentElement.addEventListener('mouseenter', stopAutoplay);
    slider.parentElement.addEventListener('mouseleave', startAutoplay);
  }

  updateSlider();
  startAutoplay();
});
</script>

{% schema %}
{
  "name": "Featured Collection",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Featured Collection"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Select Collection"
    },
    {
      "type": "range",
      "id": "products_limit",
      "label": "Total Products to Show",
      "min": 1,
      "max": 20,
      "step": 1,
      "default": 8
    },
    {
      "type": "header",
      "content": "Slider settings"
    },
    {
      "type": "range",
      "id": "slides_per_view",
      "label": "Slides Per View (Desktop)",
      "min": 1,
      "max": 4,
      "step": 1,
      "default": 4
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Enable Autoplay",
      "default": false
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "label": "Autoplay Speed (seconds)",
      "min": 2,
      "max": 10,
      "step": 1,
      "default": 5
    },
    {
      "type": "checkbox",
      "id": "pause_on_hover",
      "label": "Pause on Hover",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "dot_enable",
      "label": "Enble Dots",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "view_all_enable",
      "label": "View All",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "Featured Collection"
    }
  ]
}
{% endschema %}